@model SoOrder
@{
    var date = Model.OrderDate.ToString("yyyy-MM-dd");
    var cust = ViewData["Cust"] as List<ComCustomer> ?? new List<ComCustomer>();
    var itemList = ViewData["ItemList"] as List<SoItem> ?? new List<SoItem>();
}

<div>
    <div class="row">
        <div class="col-lg-6 col-md-6 col-sm-12">
            <div class="input-group mb-3">
                <label class="form-label col-lg-4 col-xs-12">Order No</label>
                <input type="text" class="form-control col-lg-8 col-xs-12" name="OrderNo" value="@Model.OrderNo" readonly />
            </div>
            <div class="input-group mb-3">
                <label class="form-label col-lg-4 col-xs-12">Order Date</label>
                <input type="date" class="form-control col-lg-8 col-xs-12" name="OrderDate" value="@date" />
                <input type="hidden" class="form-control col-lg-8 col-xs-12" name="SoOrderId" value="@Model.SoOrderId" />
            </div>
        </div>
        <div class="col-lg-6 col-md-6 col-sm-12">
            <div class="input-group mb-3">
                <label class="form-label col-lg-4 col-xs-12">Customer</label>
                <select class="form-control col-lg-8 col-xs-12" name="ComCustomerId">
                    <option value="">- choose customer -</option>
                    @foreach (ComCustomer l in cust)
                    {
                        if (l.ComCustomerId == Model.ComCustomerId)
                        {
                            <option value="@l.ComCustomerId" selected>@l.CustomerName</option>
                        }
                        else
                        {
                            <option value="@l.ComCustomerId">@l.CustomerName</option>
                        }
                    }
                </select>
            </div>
            <div class="input-group mb-3">
                <label class="form-label col-lg-4 col-xs-12">Address</label>
                <textarea class="form-control col-lg-8 col-xs-12" name="Address">@Model.Address</textarea>
            </div>
        </div>
    </div>
    <div>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalItem">
            Add Item
        </button>
        <button class="btn btn-success" id="btnSave">Save</button>
        <table class="table" id="tblItem">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Name</th>
                    <th>Qty</th>
                    <th>Price</th>
                    <th>Total</th>
                </tr>
            </thead>
            <tbody>
                @foreach(var l in itemList)
                {
                    <tr>
                        <td>
                            <button type="button" class="btn btn-warning btn-sm btn-edit">Edit</button>
                            <button type="button" class="btn btn-danger btn-sm btn-delete">Delete</button>
                        </td>
                        <td>@l.ItemName</td>
                        <td>@l.Quantity</td>
                        <td>@l.Price</td>
                        <td>@l.SoItemId</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>



<div class="modal fade" id="modalItem" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="exampleModalLabel">Modal title</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="mb-3">
                        <label for="exampleInputPassword1" class="form-label">Item</label>
                        <input type="text" name="Item" class="form-control" id="Item">
                    </div>
                    <div class="mb-3">
                        <label for="exampleInputPassword1" class="form-label">Qty</label>
                        <input type="number" name="Qty" class="form-control" id="Qty">
                    </div>
                    <div class="mb-3">
                        <label for="exampleInputPassword1" class="form-label">Price</label>
                        <input type="number" name="Price" class="form-control" id="Price">
                    </div>
                    <input name="ItemId" id="ItemId"/>
                    <button type="submit" class="btn btn-primary">Add</button>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
        // Event handler untuk tombol submit di modal (Tambah/Edit Item)
        $("#modalItem button[type='submit']").on("click", function (e) {
            e.preventDefault(); // Mencegah submit default form

            // Ambil nilai input dari modal
            const itemName = $("#Item").val();
            const itemQty = $("#Qty").val();
            const itemPrice = $("#Price").val();
            const itemId = $("#ItemId").val();

            // Validasi input
            if (!itemName || !itemQty || !itemPrice) {
                alert("All fields are required!");
                return;
            }

            // Hitung total harga
            const itemTotal = parseFloat(itemQty) * parseFloat(itemPrice);

            // Cek apakah sedang dalam mode edit
            const editingRow = $("#modalItem").data("editingRow");
            if (editingRow) {
                // Update data pada baris yang sedang diedit
                editingRow.find("td:nth-child(2)").text(itemName);
                editingRow.find("td:nth-child(3)").text(itemQty);
                editingRow.find("td:nth-child(4)").text(itemPrice);
                editingRow.find("td:nth-child(5)").text(itemTotal.toFixed(2));
                editingRow.find("td:nth-child(6)").text(itemId);
                $("#modalItem").removeData("editingRow");
            } else {
                // Tambahkan baris baru ke tabel
                const newRow = `
                    <tr>
                        <td></td>
                        <td>${itemName}</td>
                        <td>${itemQty}</td>
                        <td>${itemPrice}</td>
                        <td>${itemTotal.toFixed(2)}</td>
                        <td>
                            <button type="button" class="btn btn-warning btn-sm btn-edit">Edit</button>
                            <button type="button" class="btn btn-danger btn-sm btn-delete">Delete</button>
                        </td>
                    </tr>
                `;
                $("#tblItem tbody").append(newRow);
            }

            // Reset input di modal
            $("#Item").val("");
            $("#Qty").val("");
            $("#Price").val("");
            $("#ItemId").val("");

            // Tutup modal
            $("#modalItem").modal("hide");

            // Perbarui nomor urut
            renumberTable();
        });

        // Event handler untuk tombol Edit
        $(document).on("click", ".btn-edit", function () {
            const row = $(this).closest("tr");

            // Ambil data dari baris tabel
            const itemId = row.find("td:nth-child(6)").text();
            const itemName = row.find("td:nth-child(2)").text();
            const itemQty = row.find("td:nth-child(3)").text();
            const itemPrice = row.find("td:nth-child(4)").text();

            // Set data ke modal
            $("#Item").val(itemName);
            $("#ItemId").val(itemId);
            $("#Qty").val(itemQty);
            $("#Price").val(itemPrice);

            // Simpan referensi baris yang sedang diedit
            $("#modalItem").data("editingRow", row);

            // Tampilkan modal
            $("#modalItem").modal("show");
        });

        // Event handler untuk tombol Delete
        $(document).on("click", ".btn-delete", function () {
            const row = $(this).closest("tr");
            row.remove(); // Hapus baris dari tabel
            renumberTable(); // Perbarui nomor urut
        });

        // Fungsi untuk memperbarui nomor urut
        function renumberTable() {
            $("#tblItem tbody tr").each(function (index) {
                $(this).find("td:first-child").text(index + 1);
            });
        }

        // Event handler untuk tombol Save
        $("#btnSave").on("click", function () {
            // Ambil data dari form
            let orderId = $("input[name='SoOrderId']").val();
            let orderNo = $("input[name='OrderNo']").val();
            let orderDate = $("input[name='OrderDate']").val();
            let comCustomerId = $("select[name='ComCustomerId']").val();
            let address = $("textarea[name='Address']").val();

            // Validasi input form
            if (!orderDate || !comCustomerId) {
                alert("Order Date and Customer are required.");
                return;
            }

            // Ambil data item dari tabel
            let items = [];
            $("#tblItem tbody tr").each(function () {
                
                const itemName = $(this).find("td:nth-child(2)").text();
                const itemQty = $(this).find("td:nth-child(3)").text();
                const itemPrice = $(this).find("td:nth-child(4)").text();
                const itemTotal = $(this).find("td:nth-child(5)").text();
                const itemId = $(this).find("td:nth-child(6)").text();
                console.log("id" + itemId);
                items.push({
                    ItemId:parseInt(itemId),
                    Name: itemName,
                    Qty: parseInt(itemQty),
                    Price: parseFloat(itemPrice),
                    Total: parseFloat(itemTotal)
                });
            });

            if (items.length === 0) {
                alert("No items to save!");
                return;
            }

            // Kirim data ke server
            $.ajax({
                url: '/Order/Update', // Ganti dengan endpoint Anda
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    SoOrderId: orderId,
                    OrderNo: orderNo,
                    OrderDate: orderDate,
                    ComCustomerId: comCustomerId,
                    Address: address,
                    Items: items
                }),
                success: function (response) {
                    alert("Order saved successfully!");
                    location.reload(); // Opsional: Reload halaman
                },
                error: function (xhr) {
                    alert("Failed to save order: " + xhr.responseText);
                }
            });
        });
    });

</script>

